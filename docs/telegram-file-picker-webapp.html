<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>touchgrass file picker</title>
    <style>
      :root {
        color-scheme: light dark;
      }
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      }
      .app {
        max-width: 720px;
        margin: 0 auto;
        padding: 16px;
      }
      h1 {
        margin: 0 0 8px;
        font-size: 18px;
      }
      p {
        margin: 0 0 12px;
        opacity: 0.8;
      }
      input {
        width: 100%;
        box-sizing: border-box;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(127, 127, 127, 0.4);
        margin-bottom: 12px;
        font-size: 15px;
      }
      .list {
        display: grid;
        gap: 8px;
      }
      button.file {
        display: block;
        width: 100%;
        text-align: left;
        border: 1px solid rgba(127, 127, 127, 0.35);
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 14px;
        background: transparent;
        cursor: pointer;
      }
      .empty {
        opacity: 0.7;
      }
      .hint {
        margin-top: 12px;
        font-size: 12px;
        opacity: 0.7;
      }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
  </head>
  <body>
    <main class="app">
      <h1>Select file</h1>
      <p id="subtitle"></p>
      <input id="q" placeholder="Search files..." autocomplete="off" />
      <div id="list" class="list"></div>
      <p class="hint">If Telegram is unavailable, selection is logged to console.</p>
    </main>
    <script>
      function decodeBase64Url(input) {
        const b64 = input.replace(/-/g, "+").replace(/_/g, "/");
        const pad = b64.length % 4 === 0 ? "" : "=".repeat(4 - (b64.length % 4));
        return atob(b64 + pad);
      }

      function parsePayload() {
        const params = new URLSearchParams(window.location.search);
        const raw = params.get("tgfp");
        if (!raw) return null;
        try {
          return JSON.parse(decodeBase64Url(raw));
        } catch {
          return null;
        }
      }

      const payload = parsePayload() || { token: "", files: [], query: "" };
      const token = String(payload.token || "");
      const files = Array.isArray(payload.files) ? payload.files.map(String) : [];
      const initialQuery = String(payload.query || "");

      const listEl = document.getElementById("list");
      const qEl = document.getElementById("q");
      const subtitleEl = document.getElementById("subtitle");
      subtitleEl.textContent = files.length
        ? `${files.length} files available`
        : "No files in payload. Run /files again.";

      function score(file, query) {
        const f = file.toLowerCase();
        const q = query.toLowerCase();
        if (!q) return 0;
        if (f === q) return 0;
        if (f.includes("/" + q)) return 1;
        if (f.includes(q)) return 2;
        return 10;
      }

      function sendSelection(file) {
        const data = JSON.stringify({ kind: "tg_files_pick", token, file });
        if (window.Telegram && window.Telegram.WebApp) {
          window.Telegram.WebApp.sendData(data);
          window.Telegram.WebApp.close();
          return;
        }
        console.log("Selection payload:", data);
      }

      function render(query) {
        const q = (query || "").trim();
        const ranked = files
          .map((file) => ({ file, score: score(file, q) }))
          .filter((x) => x.score < 10)
          .sort((a, b) => a.score - b.score || a.file.length - b.file.length || a.file.localeCompare(b.file))
          .slice(0, 80);

        listEl.innerHTML = "";
        if (!ranked.length) {
          const p = document.createElement("p");
          p.className = "empty";
          p.textContent = "No matches.";
          listEl.appendChild(p);
          return;
        }

        for (const entry of ranked) {
          const button = document.createElement("button");
          button.type = "button";
          button.className = "file";
          button.textContent = entry.file;
          button.addEventListener("click", () => sendSelection(entry.file));
          listEl.appendChild(button);
        }
      }

      qEl.value = initialQuery;
      qEl.addEventListener("input", () => render(qEl.value));
      render(initialQuery);

      if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
      }
    </script>
  </body>
</html>
